#!/usr/bin/env bash
set -e

die() {
	echo "$@"
	exit 1
}

type pause >/dev/null || die "pause not found!"

while getopts :f arg; do
	case "$arg" in
		f) use_file=1 ;;
		*) die "Invalid option $OPTARG" ;;
	esac
	shift
done

(($# < 2)) && die "Specify at least the config directory and command to run!"
dir="$1"
cmd="$2"
[ -d "$dir" ] || die "Not a directory: $dir"
type "$cmd" >/dev/null 2>&1 || die "Not found: $cmd"
shift 2

cleanup() {
	pkill -P "$$"
}

cleanup_with_file() {
	rm "$file"
	cleanup
}

generate() {
	find "$dir" -maxdepth 1 -not -type d -print0 | xargs --null cat
}

echo -n "$cmd-wrapper" > /proc/$$/comm

trap cleanup EXIT
((use_file == 1)) && {
	file="$(mktemp)"
	trap cleanup_with_file EXIT
	trap 'generate > "$file"' USR1
}

while true; do
	if ((use_file == 1)); then
		kill -USR1 "$$"
		"$cmd" "$@" "$file" &
		pause
	else
		generate | "$cmd" "$@"
	fi
done
