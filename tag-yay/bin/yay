#!/usr/bin/env bash

die() {
	echo "$@"
	exit 1
}

if (($# < 1)); then
	# system upgrade
	sudo xbps-install -S
	sudo xbps-install -u xbps
	sudo xbps-install -u linux
	sudo xbps-remove -o
	sudo xbps-install -u
elif [ "$1" == "-Yc" ]; then
	# remove orphans
	shift
	sudo xbps-remove -Ro "$@"
elif [ "$1" == "-Sc" ]; then
	# clean cache
	shift
	sudo xbps-remove -O "$@"
elif [ "$1" == "-S" ]; then
	sudo xbps-install "$2"
else
	# search for package
	command -v fzf >/dev/null || die "fzf not found!"
	IFS=$'\n' read -r -d '' -a packages <<< "$(
		xbps-query -Rs "" \
		| fzf -m -e -q "$*" \
		| awk '{gsub("-[^-]+_[^_]+$", "", $2); print $2}'
	)"
	((${#packages[@]} < 1)) && die "Nothing selected"
	echo "Installing ${packages[*]}"
	sudo xbps-install "${packages[@]}"
fi
